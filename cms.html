<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog CMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #fafafa;
            --text: #1a1a1a;
            --text-secondary: #666;
            --text-tertiary: #999;
            --accent: #2563eb;
            --border: #e5e5e5;
            --card-bg: #ffffff;
            --hover-bg: #f5f5f5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
        }

        body.dark {
            --bg: #0a0a0a;
            --text: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-tertiary: #666;
            --accent: #60a5fa;
            --border: #262626;
            --card-bg: #141414;
            --hover-bg: #1a1a1a;
        }

        .config-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .config-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
            line-height: 1.5;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--hover-bg);
            color: var(--text);
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .post-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s;
            position: relative;
        }

        .post-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .post-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .post-card .meta {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .post-card .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .category-tag {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .post-card .actions {
            display: flex;
            gap: 8px;
        }

        .post-card .btn {
            padding: 6px 14px;
            font-size: 0.85rem;
            flex: 1;
        }

        .status {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
            display: block;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            display: block;
        }

        .editor-section {
            display: none;
        }

        .editor-section.active {
            display: block;
        }

        .hidden {
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            margin: 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .category-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .category-input-group input {
            flex: 1;
        }

        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .category-item {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-item button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 1.1rem;
            line-height: 1;
        }

        .category-item button:hover {
            color: #ef4444;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .post-card {
            animation: fadeIn 0.3s ease;
        }

        @media (max-width: 640px) {
            .posts-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>✍️ Blog CMS</h1>
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
        </header>

        <div id="status" class="status"></div>

        <!-- 설정 섹션 -->
        <div class="config-section" id="configSection">
            <h2>GitHub 연결</h2>
            <div class="form-group">
                <label>GitHub Username</label>
                <input type="text" id="username" placeholder="your-username">
            </div>
            <div class="form-group">
                <label>Repository Name</label>
                <input type="text" id="repo" placeholder="blog-posts">
            </div>
            <div class="form-group">
                <label>Personal Access Token</label>
                <input type="password" id="token" placeholder="ghp_...">
            </div>
            <button class="btn btn-primary" onclick="saveConfig()">
                <span>→</span> 연결하기
            </button>
        </div>

        <!-- 포스트 목록 -->
        <div id="postsSection" class="hidden">
            <div class="section-header">
                <h2>포스트 목록</h2>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-ghost" onclick="loadPosts()">
                        <span>🔄</span> 새로고침
                    </button>
                    <button class="btn btn-primary" onclick="showNewPostEditor()">
                        <span>+</span> 새 글 작성
                    </button>
                </div>
            </div>
            <div id="postsList" class="posts-grid"></div>
        </div>

        <!-- 에디터 섹션 -->
        <div id="editorSection" class="editor-section">
            <div class="config-section">
                <div class="section-header">
                    <h2 id="editorTitle">새 글 작성</h2>
                    <button class="btn btn-ghost" onclick="closeEditor()">
                        <span>←</span> 목록으로
                    </button>
                </div>
                
                <div class="form-group">
                    <label>제목</label>
                    <input type="text" id="postTitle" placeholder="글 제목">
                </div>

                <div class="form-group">
                    <label>날짜</label>
                    <input type="date" id="postDate">
                </div>
                
                <div class="form-group">
                    <label>파일명 (영문, 하이픈 사용)</label>
                    <input type="text" id="postSlug" placeholder="2025-03-15-my-first-post">
                </div>

                <div class="form-group">
                    <label>카테고리</label>
                    <div class="category-input-group">
                        <input type="text" id="categoryInput" placeholder="카테고리 이름 입력">
                        <button class="btn btn-ghost btn-small" onclick="addCategory()">추가</button>
                    </div>
                    <div class="categories-list" id="categoriesList"></div>
                </div>
                
                <div class="form-group">
                    <label>내용 (Markdown)</label>
                    <textarea id="postContent" placeholder="여기에 내용을 작성하세요..."></textarea>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="savePost()">
                        <span>💾</span> 저장
                    </button>
                    <button class="btn btn-ghost" onclick="closeEditor()">취소</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let config = {
            username: '',
            repo: '',
            token: ''
        };
        
        let posts = [];
        let currentEditingPost = null;
        let currentCategories = [];

        window.onload = function() {
            const saved = localStorage.getItem('githubConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('username').value = config.username;
                document.getElementById('repo').value = config.repo;
                document.getElementById('token').value = config.token;
                
                if (config.username && config.repo && config.token) {
                    loadPosts();
                }
            }

            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }

            // 날짜 입력 기본값 설정 (오늘)
            document.getElementById('postDate').valueAsDate = new Date();
        };

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }

        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }

        function saveConfig() {
            config.username = document.getElementById('username').value.trim();
            config.repo = document.getElementById('repo').value.trim();
            config.token = document.getElementById('token').value.trim();

            if (!config.username || !config.repo || !config.token) {
                showStatus('모든 필드를 입력해주세요', true);
                return;
            }

            localStorage.setItem('githubConfig', JSON.stringify(config));
            showStatus('설정이 저장되었습니다');
            loadPosts();
        }

        async function loadPosts() {
            if (!config.token) {
                showStatus('먼저 GitHub 설정을 완료해주세요', true);
                return;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${config.username}/${config.repo}/contents`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('저장소를 불러올 수 없습니다. 설정을 확인해주세요.');
                }

                const files = await response.json();
                posts = files.filter(file => file.name.endsWith('.md'));
                
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('postsSection').classList.remove('hidden');
                displayPosts();
                
            } catch (error) {
                showStatus(error.message, true);
            }
        }

        function parseFrontMatter(content) {
            const frontMatterRegex = /^---\n([\s\S]*?)\n---\n([\s\S]*)$/;
            const match = content.match(frontMatterRegex);
            
            if (match) {
                const frontMatter = {};
                const lines = match[1].split('\n');
                
                lines.forEach(line => {
                    const [key, ...valueParts] = line.split(':');
                    if (key && valueParts.length) {
                        const value = valueParts.join(':').trim();
                        if (key.trim() === 'categories') {
                            // [카테고리1, 카테고리2] 형식 파싱
                            frontMatter.categories = value
                                .replace(/[\[\]]/g, '')
                                .split(',')
                                .map(c => c.trim())
                                .filter(c => c);
                        } else {
                            frontMatter[key.trim()] = value;
                        }
                    }
                });
                
                return {
                    frontMatter,
                    content: match[2]
                };
            }
            
            return { frontMatter: {}, content };
        }

        async function displayPosts() {
            const container = document.getElementById('postsList');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <p>아직 작성된 글이 없습니다</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">새 글을 작성해보세요!</p>
                    </div>
                `;
                return;
            }

            // 각 포스트의 내용을 가져와서 front matter 파싱
            const postsWithMeta = await Promise.all(posts.map(async post => {
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${config.username}/${config.repo}/contents/${post.name}`,
                        {
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    const file = await response.json();
                    const content = decodeURIComponent(escape(atob(file.content)));
                    const { frontMatter } = parseFrontMatter(content);
                    
                    return {
                        ...post,
                        title: frontMatter.title || post.name.replace('.md', ''),
                        date: frontMatter.date || '',
                        categories: frontMatter.categories || []
                    };
                } catch (e) {
                    return {
                        ...post,
                        title: post.name.replace('.md', ''),
                        date: '',
                        categories: []
                    };
                }
            }));

            container.innerHTML = postsWithMeta.map(post => `
                <div class="post-card">
                    <h3>${post.title}</h3>
                    <div class="meta">${post.date || post.name}</div>
                    ${post.categories.length > 0 ? `
                        <div class="categories">
                            ${post.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="actions">
                        <button class="btn btn-ghost" onclick="editPost('${post.name}')">수정</button>
                        <button class="btn btn-ghost" onclick="deletePost('${post.name}', '${post.sha}')" style="color: #ef4444;">삭제</button>
                    </div>
                </div>
            `).join('');
        }

        function addCategory() {
            const input = document.getElementById('categoryInput');
            const category = input.value.trim();
            
            if (category && !currentCategories.includes(category)) {
                currentCategories.push(category);
                renderCategories();
                input.value = '';
            }
        }

        function removeCategory(category) {
            currentCategories = currentCategories.filter(c => c !== category);
            renderCategories();
        }

        function renderCategories() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = currentCategories.map(cat => `
                <div class="category-item">
                    <span>${cat}</span>
                    <button onclick="removeCategory('${cat}')">×</button>
                </div>
            `).join('');
        }

        function showNewPostEditor() {
            currentEditingPost = null;
            currentCategories = [];
            document.getElementById('editorTitle').textContent = '새 글 작성';
            document.getElementById('postTitle').value = '';
            document.getElementById('postDate').valueAsDate = new Date();
            document.getElementById('postSlug').value = '';
            document.getElementById('postContent').value = '';
            renderCategories();
            
            document.getElementById('postsSection').classList.add('hidden');
            document.getElementById('editorSection').classList.add('active');
        }

        async function editPost(filename) {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${config.username}/${config.repo}/contents/${filename}`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                const file = await response.json();
                const content = decodeURIComponent(escape(atob(file.content)));
                const { frontMatter, content: bodyContent } = parseFrontMatter(content);
                
                currentEditingPost = { filename, sha: file.sha };
                currentCategories = frontMatter.categories || [];
                
                document.getElementById('editorTitle').textContent = '글 수정';
                document.getElementById('postTitle').value = frontMatter.title || filename.replace('.md', '');
                document.getElementById('postDate').value = frontMatter.date || '';
                document.getElementById('postSlug').value = filename.replace('.md', '');
                document.getElementById('postContent').value = bodyContent.trim();
                renderCategories();
                
                document.getElementById('postsSection').classList.add('hidden');
                document.getElementById('editorSection').classList.add('active');
                
            } catch (error) {
                showStatus('글을 불러올 수 없습니다', true);
            }
        }

        async function savePost() {
            const title = document.getElementById('postTitle').value.trim();
            const date = document.getElementById('postDate').value;
            const slug = document.getElementById('postSlug').value.trim();
            const bodyContent = document.getElementById('postContent').value;

            if (!title || !slug || !bodyContent) {
                showStatus('제목, 파일명, 내용을 모두 입력해주세요', true);
                return;
            }

            const filename = slug.endsWith('.md') ? slug : slug + '.md';
            
            // Front Matter 생성
            let frontMatter = `---\ntitle: ${title}\n`;
            if (date) {
                frontMatter += `date: ${date}\n`;
            }
            if (currentCategories.length > 0) {
                frontMatter += `categories: [${currentCategories.join(', ')}]\n`;
            }
            frontMatter += `---\n\n`;
            
            const fullContent = frontMatter + bodyContent;
            
            try {
                const body = {
                    message: currentEditingPost ? `Update ${filename}` : `Create ${filename}`,
                    content: btoa(unescape(encodeURIComponent(fullContent)))
                };

                if (currentEditingPost) {
                    body.sha = currentEditingPost.sha;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${config.username}/${config.repo}/contents/${filename}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (!response.ok) {
                    throw new Error('저장에 실패했습니다');
                }

                showStatus('글이 저장되었습니다!');
                closeEditor();
                await loadPosts();
                
            } catch (error) {
                showStatus(error.message, true);
            }
        }

        async function deletePost(filename, sha) {
            if (!confirm(`"${filename}"을(를) 정말 삭제하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${config.username}/${config.repo}/contents/${filename}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete ${filename}`,
                            sha: sha
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('삭제에 실패했습니다');
                }

                showStatus('글이 삭제되었습니다');
                await loadPosts();
                
            } catch (error) {
                showStatus(error.message, true);
            }
        }

        function closeEditor() {
            document.getElementById('editorSection').classList.remove('active');
            document.getElementById('postsSection').classList.remove('hidden');
        }

        // Enter 키로 카테고리 추가
        document.addEventListener('DOMContentLoaded', () => {
            const categoryInput = document.getElementById('categoryInput');
            if (categoryInput) {
                categoryInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCategory();
                    }
                });
            }
        });
    </script>
</body>
</html>